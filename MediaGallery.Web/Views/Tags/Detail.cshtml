@model TagDetailViewModel
@using System.Linq
@using System.Text.Json
@using MediaGallery.Web.Services.Models
@{
    ViewData["Title"] = $"Tag: {Model.Tag}";
    var jsonOptions = new JsonSerializerOptions(JsonSerializerDefaults.Web);
    var feedEndpoint = Url.Action("DetailData", new { tag = Model.Tag, pageSize = Model.Pagination.PageSize });
    var initialData = new TagDetailDataResult(Model.Tag, new PagedResult<TaggedPhoto>(Model.Photos, Model.Pagination));
    var relatedTags = Model.Photos
        .SelectMany(photo => photo.Tags)
        .Select(tag => tag.Tag)
        .Where(tag => !string.Equals(tag, Model.Tag, StringComparison.OrdinalIgnoreCase))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .Take(12)
        .ToList();
}

<section class="page-header">
    <div>
        <h1>@ViewData["Title"]</h1>
        <p class="lead">@Model.Photos.Count.ToString("N0") media items currently indexed for <strong>@Model.Tag</strong>.</p>
    </div>
    <div class="page-header__meta">
        <span class="badge">Page @Model.Pagination.PageNumber</span>
        @if (Model.Pagination.HasNextPage)
        {
            <span class="badge badge--subtle">More results available</span>
        }
    </div>
</section>

<section class="tag-detail" data-tag-view="detail" data-tag="@Model.Tag" data-feed-endpoint="@feedEndpoint" data-media-root="@Url.Content("~/media/")">
    <div class="tag-detail__meta">
        <h2>Related tags</h2>
        @if (relatedTags.Any())
        {
            <ul class="chip-list">
                @foreach (var related in relatedTags)
                {
                    <li><a class="chip" asp-controller="Tags" asp-action="Detail" asp-route-tag="@related">@related</a></li>
                }
            </ul>
        }
        else
        {
            <p class="panel__empty">No additional tags detected in this slice.</p>
        }
    </div>

    <div class="media-gallery-grid" data-gallery aria-label="Media for @Model.Tag"></div>
    <div class="scroll-status" data-scroll-status aria-live="polite"></div>
    <div class="scroll-sentinel" data-scroll-sentinel></div>
</section>

<script type="application/json" id="tag-detail-data">
    @Html.Raw(JsonSerializer.Serialize(initialData, jsonOptions))
</script>

@section Scripts {
    <script type="module" src="~/js/tagGallery.js" asp-append-version="true"></script>
}
