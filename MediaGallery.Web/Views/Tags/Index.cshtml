@model MediaGallery.Web.ViewModels.TagIndexViewModel
@using System.Collections.Generic
@using System.Linq
@using MediaGallery.Web.Controllers
@{
    ViewData["Title"] = "Tags";

    var query = Context.Request.Query;
    var userValue = query["userId"].ToString();
    var hasUser = long.TryParse(userValue, out var userId);
    var pageSizeValue = query["pageSize"].ToString();
    var hasPageSize = int.TryParse(pageSizeValue, out var pageSize);
    var pagination = Model.Pagination;

    var queryParameters = new Dictionary<string, object?>
    {
        ["userId"] = hasUser ? userId : null,
        ["pageSize"] = hasPageSize ? pageSize : pagination.PageSize
    };

    string BuildPageUrl(int pageNumber)
    {
        var parameters = new Dictionary<string, object?>
        {
            ["page"] = pageNumber
        };

        foreach (var pair in queryParameters)
        {
            if (pair.Value is not null)
            {
                parameters[pair.Key] = pair.Value;
            }
        }

        return Url.Action("Index", "Tags", parameters) ?? string.Empty;
    }

    var userIdAttribute = hasUser ? userId.ToString() : string.Empty;
}

<section class="page-header">
    <span class="page-header__eyebrow">Tag intelligence</span>
    <h1>@ViewData["Title"]</h1>
    <p class="lead">Pick a tag to drill deeper into related photos and videos. Use the preview panel to eyeball relevance before opening the detail view.</p>
</section>

<form method="get" class="filter-form" aria-label="Filter tags">
    <div class="filter-field">
        <label for="userId">Limit to user ID</label>
        <input type="number" id="userId" name="userId" value="@userValue" placeholder="Any" min="1" />
    </div>
    <div class="filter-field">
        <label for="pageSize">Page size</label>
        <input type="number" id="pageSize" name="pageSize" value="@(hasPageSize ? pageSize : pagination.PageSize)" min="1" max="@PaginationHelper.MaxPageSizeLimit" />
    </div>
    <div class="filter-actions">
        <button class="btn btn-primary" type="submit">Apply</button>
        <a class="btn btn-ghost" asp-controller="Tags" asp-action="Index">Reset</a>
    </div>
</form>

<section class="tag-browser"
         data-tag-view="index"
         data-media-root="@Url.Content("~/media/")"
         data-detail-endpoint="@Url.Action("DetailData", "Tags")"
         data-detail-page="@Url.Action("Detail", "Tags")"
         data-query-endpoint="@Url.Action("QueryData", "Tags")"
         data-query-page="@Url.Action("Query", "Tags")"
         data-index-endpoint="@Url.Action("IndexData", "Tags")"
         data-page-number="@pagination.PageNumber"
         data-page-size="@pagination.PageSize"
         data-user-id="@userIdAttribute"
         data-preview-page-size="8">
    <div class="tag-browser__list" data-tag-list aria-label="Available tags">
        <div class="tag-browser__controls">
            <label class="sr-only" for="tagSearch">Search tags</label>
            <input type="search" id="tagSearch" class="tag-browser__search" data-tag-search placeholder="Search tags" autocomplete="off" spellcheck="false" />
            <span class="tag-browser__count" data-tag-count>@Model.Tags.Count tag@(Model.Tags.Count == 1 ? string.Empty : "s")</span>
        </div>

        @if (!Model.Tags.Any())
        {
            <div class="empty-state">
                <p>No tags found. Try adjusting the filters or check back after new media is processed.</p>
            </div>
        }
        else
        {
            <div class="tag-browser__grid" data-tag-grid>
                @foreach (var tag in Model.Tags)
                {
                    <article class="tag-card" data-tag="@tag.Tag">
                        <button class="tag-card__preview" type="button" data-action="preview-tag" data-tag="@tag.Tag" title="Preview @tag.Tag">@tag.Tag</button>
                        <p class="tag-card__count">@tag.PhotoCount media item@(tag.PhotoCount == 1 ? string.Empty : "s")</p>
                        <div class="tag-card__actions">
                            <button class="tag-card__action tag-card__action--include" type="button" data-action="include-tag" data-tag="@tag.Tag" title="Include @tag.Tag" aria-label="Include tag @tag.Tag">+</button>
                            <button class="tag-card__action tag-card__action--exclude" type="button" data-action="exclude-tag" data-tag="@tag.Tag" title="Exclude @tag.Tag" aria-label="Exclude tag @tag.Tag">âˆ’</button>
                            <a class="tag-card__detail" asp-controller="Tags" asp-action="Detail" asp-route-tag="@tag.Tag" title="Open detail for @tag.Tag">Detail</a>
                        </div>
                    </article>
                }
            </div>
        }
    </div>

    <aside class="tag-browser__preview" aria-live="polite">
        <section class="tag-query" aria-label="Tag query builder" data-tag-query>
            <h2 class="tag-query__title">Build a tag query</h2>
            <p class="tag-query__hint">Include tags that must appear together and exclude tags you want to avoid. Queries update automatically.</p>
            <div class="tag-query__group">
                <h3>Include</h3>
                <div class="tag-query__chips" data-include-list></div>
            </div>
            <div class="tag-query__group">
                <h3>Exclude</h3>
                <div class="tag-query__chips" data-exclude-list></div>
            </div>
            <div class="tag-query__actions">
                <button class="btn btn-secondary" type="button" data-action="run-query">Refresh preview</button>
                <button class="btn btn-primary" type="button" data-action="open-query-detail" disabled aria-disabled="true">Open full results</button>
                <button class="btn btn-ghost" type="button" data-action="reset-query">Clear</button>
            </div>
        </section>

        <h2 class="tag-browser__preview-title" data-preview-title>Preview</h2>
        <div class="media-carousel media-carousel--preview" data-carousel>
            <button class="media-carousel__control media-carousel__control--prev" type="button" data-carousel-prev aria-label="Previous preview item">
                <span aria-hidden="true">&#10094;</span>
            </button>
            <div class="media-carousel__viewport" data-carousel-viewport tabindex="0">
                <div class="media-carousel__track" data-carousel-track data-preview-gallery data-gallery></div>
            </div>
            <button class="media-carousel__control media-carousel__control--next" type="button" data-carousel-next aria-label="Next preview item">
                <span aria-hidden="true">&#10095;</span>
            </button>
        </div>
        <div class="scroll-status" data-scroll-status aria-live="polite">Add tags to the query or preview a tag to see media here.</div>
    </aside>
</section>

<nav class="pagination" aria-label="Tag pagination">
    <span class="pagination__info">Page @pagination.PageNumber</span>
    <div class="pagination__actions">
        @if (pagination.HasPreviousPage)
        {
            <a class="btn btn-outline" href="@BuildPageUrl(pagination.PageNumber - 1)">Previous</a>
        }
        else
        {
            <button class="btn btn-outline" type="button" disabled>Previous</button>
        }

        @if (pagination.HasNextPage)
        {
            <a class="btn btn-outline" href="@BuildPageUrl(pagination.PageNumber + 1)">Next</a>
        }
        else
        {
            <button class="btn btn-outline" type="button" disabled>Next</button>
        }
    </div>
</nav>

@section Scripts {
    <script type="module" src="~/js/tagGallery.js" asp-append-version="true"></script>
}
