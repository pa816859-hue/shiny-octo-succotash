@model PhotoFeedViewModel
@{
    ViewData["Title"] = "Photo feed";
}

<div class="photo-feed">
    @if (!Model.HasPhoto)
    {
        <div class="photo-feed__empty">
            <h1 class="photo-feed__title">No photos available right now</h1>
            <p class="photo-feed__subtitle">Once new images arrive you'll be able to swipe through them here.</p>
            <a class="btn btn-primary" asp-controller="Home" asp-action="Index">Return to dashboard</a>
        </div>
    }
    else
    {
        var photo = Model.CurrentPhoto!;
        <div class="photo-stage" data-photo-id="@photo.PhotoId" data-like-url="@Url.Action("Like", "Photos")" data-next-url="@Url.Action("Next", "Photos")">
            <div class="photo-stage__frame">
                <img class="photo-stage__image" src="@photo.SourceUrl" alt="Photo @photo.PhotoId" loading="lazy" />
            </div>
            <aside class="photo-stage__actions" aria-label="Photo actions">
                <button type="button" class="photo-action photo-action--like@(photo.IsLiked ? " is-active" : string.Empty)" id="likeButton">
                    <span aria-hidden="true">‚ù§</span>
                    <span>Like</span>
                </button>
                <button type="button" class="photo-action photo-action--next" id="nextButton">
                    <span aria-hidden="true">‚è≠</span>
                    <span>Next</span>
                </button>
                <a class="photo-action photo-action--link" asp-action="Liked" asp-controller="Photos">
                    <span aria-hidden="true">‚ô•</span>
                    <span>Liked</span>
                </a>
                <a class="photo-action photo-action--link" asp-controller="Messages" asp-action="MediaChronology" asp-route-photoId="@photo.PhotoId">
                    <span aria-hidden="true">üïë</span>
                    <span>Chronology</span>
                </a>
            </aside>
            <div class="photo-stage__status" hidden></div>
        </div>
        <div class="photo-stage__meta">
            <p class="photo-stage__id">Photo #@photo.PhotoId</p>
            <p class="photo-stage__timestamp">Added @photo.AddedOn.ToString("g")</p>
        </div>
    }
</div>

<form id="photoActionsForm" method="post">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        (() => {
            const stage = document.querySelector('.photo-stage');
            if (!stage) {
                return;
            }

            const imageElement = stage.querySelector('.photo-stage__image');
            const likeButton = document.getElementById('likeButton');
            const nextButton = document.getElementById('nextButton');
            const statusBanner = stage.querySelector('.photo-stage__status');
            let dismissHandle = null;

            const tokenInput = document.querySelector('#photoActionsForm input[name="__RequestVerificationToken"]');
            const antiForgeryToken = tokenInput ? tokenInput.value : '';

            const setStatus = (message, state) => {
                if (!statusBanner) {
                    return;
                }

                if (dismissHandle) {
                    window.clearTimeout(dismissHandle);
                    dismissHandle = null;
                }

                if (!message) {
                    statusBanner.hidden = true;
                    statusBanner.textContent = '';
                    statusBanner.dataset.state = '';
                    return;
                }

                statusBanner.hidden = false;
                statusBanner.textContent = message;
                statusBanner.dataset.state = state || '';

                dismissHandle = window.setTimeout(() => {
                    statusBanner.hidden = true;
                    statusBanner.textContent = '';
                    statusBanner.dataset.state = '';
                    dismissHandle = null;
                }, 2400);
            };

            const updateStage = (payload) => {
                if (!payload || !payload.hasPhoto || !payload.photo) {
                    stage.dataset.photoId = '';
                    setStatus('No more photos available right now.', 'empty');
                    if (imageElement) {
                        imageElement.src = '';
                        imageElement.alt = 'No photo available';
                    }
                    if (likeButton) {
                        likeButton.classList.remove('is-active');
                        likeButton.setAttribute('disabled', 'disabled');
                    }
                    if (nextButton) {
                        nextButton.setAttribute('disabled', 'disabled');
                    }
                    const metaId = document.querySelector('.photo-stage__id');
                    const metaTimestamp = document.querySelector('.photo-stage__timestamp');
                    if (metaId) {
                        metaId.textContent = 'No photo ready';
                    }
                    if (metaTimestamp) {
                        metaTimestamp.textContent = 'Check back soon';
                    }
                    return;
                }

                const photo = payload.photo;
                stage.dataset.photoId = photo.photoId;
                if (likeButton) {
                    likeButton.removeAttribute('disabled');
                }
                if (nextButton) {
                    nextButton.removeAttribute('disabled');
                }
                if (imageElement) {
                    imageElement.src = photo.sourceUrl;
                    imageElement.alt = `Photo ${photo.photoId}`;
                }

                if (likeButton) {
                    if (photo.isLiked) {
                        likeButton.classList.add('is-active');
                    } else {
                        likeButton.classList.remove('is-active');
                    }
                }

                const metaId = document.querySelector('.photo-stage__id');
                const metaTimestamp = document.querySelector('.photo-stage__timestamp');
                if (metaId) {
                    metaId.textContent = `Photo #${photo.photoId}`;
                }
                if (metaTimestamp) {
                    const addedOn = new Date(photo.addedOn);
                    metaTimestamp.textContent = `Added ${addedOn.toLocaleString()}`;
                }

                setStatus('', '');
            };

            const sendAction = async (url) => {
                if (!url) {
                    return;
                }

                const currentId = stage.dataset.photoId;
                if (!currentId) {
                    return;
                }

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': antiForgeryToken
                        },
                        body: JSON.stringify({ photoId: Number(currentId) })
                    });

                    if (!response.ok) {
                        setStatus('Something went wrong. Please try again.', 'error');
                        return;
                    }

                    const payload = await response.json();
                    updateStage(payload);
                } catch (error) {
                    console.error('Photo action failed', error);
                    setStatus('Unable to contact the server.', 'error');
                }
            };

            likeButton?.addEventListener('click', () => sendAction(stage.dataset.likeUrl));
            nextButton?.addEventListener('click', () => sendAction(stage.dataset.nextUrl));
        })();
    </script>
}
